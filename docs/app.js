import init, {
  init_panic_hook,
  set_cards_json,
  analyze_inventory_json,
  search_cards_json,
  get_card_by_id_json,
} from "./wasm/k2_wasm.js";

async function loadText(url) {
  const r = await fetch(url, { cache: "no-cache" });
  if (!r.ok) throw new Error(`Failed to fetch ${url}: ${r.status}`);
  return await r.text();
}

function $(id) {
  return document.getElementById(id);
}

async function boot() {
  // WASM glue is generated by wasm-pack into docs/wasm/
  await init();
  init_panic_hook();

  const cardsJson = await loadText("./cards.json");
  set_cards_json(cardsJson);

  const inventorySample = await loadText("./inventory.sample.json");
  $("inventory").value = inventorySample;

  $("btnAnalyze").addEventListener("click", () => {
    try {
      const report = analyze_inventory_json($("inventory").value);
      $("report").textContent = report;
    } catch (e) {
      $("report").textContent = String(e);
    }
  });

  $("btnSearch").addEventListener("click", () => {
    const q = $("searchQuery").value.trim();
    if (!q) {
      $("searchResult").textContent = "";
      return;
    }

    try {
      // If user provides exact id, you can fetch the card directly.
      // Otherwise we do a fuzzy search.
      if (/^[a-z0-9_\-]+$/i.test(q)) {
        try {
          const card = get_card_by_id_json(q);
          $("searchResult").textContent = card;
          return;
        } catch {
          // ignore and fall back to search
        }
      }

      const hits = search_cards_json(q, 20);
      $("searchResult").textContent = hits;
    } catch (e) {
      $("searchResult").textContent = String(e);
    }
  });
}

boot().catch((e) => {
  const msg = `BOOT ERROR: ${e?.stack || e}`;
  document.body.innerHTML = `<pre style="white-space:pre-wrap">${msg}</pre>`;
});
