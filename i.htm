<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä + –ü—Ä–∞–≤–∏–ª–∞ ‚Äî GitHub Pages</title>
  <style>
    :root{
      --bg:#0b0f14; --panel:#101823; --panel2:#0f1620; --text:#e7eef8; --muted:#9ab0c7;
      --line:#213042; --accent:#5fb3ff; --danger:#ff6b6b; --ok:#55d38a;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --r:16px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font: 14px/1.35 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background: radial-gradient(1200px 800px at 10% 0%, rgba(95,179,255,.18), transparent 60%),
                  radial-gradient(1000px 700px at 90% 10%, rgba(85,211,138,.14), transparent 55%),
                  var(--bg);
      color:var(--text);
    }
    .wrap{max-width:980px; margin:0 auto; padding:16px 14px 28px}
    header{display:flex; gap:12px; align-items:flex-start; justify-content:space-between; flex-wrap:wrap; margin-bottom:12px}
    h1{margin:0; font-size:18px}
    .sub{color:var(--muted); margin-top:4px; max-width:78ch}
    .grid{display:grid; grid-template-columns: 1fr; gap:12px}
    .card{
      background: linear-gradient(180deg, rgba(16,24,35,.92), rgba(15,22,32,.88));
      border:1px solid var(--line);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card h2{
      margin:0; padding:12px 14px;
      font-size:14px;
      border-bottom:1px solid rgba(33,48,66,.6);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .card .body{padding:14px}
    label{color:var(--muted); font-weight:650; font-size:12px}
    input[type="text"], input[type="number"], select, textarea{
      width:100%;
      background: rgba(8,12,18,.7);
      border:1px solid rgba(33,48,66,.9);
      color:var(--text);
      padding:10px 10px;
      border-radius: 12px;
      outline:none;
    }
    textarea{min-height:120px; resize:vertical}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .row + .row{margin-top:10px}
    .btn{
      appearance:none; border:1px solid rgba(33,48,66,.95);
      background: rgba(22,33,50,.7);
      color:var(--text);
      padding:10px 12px; border-radius: 12px;
      cursor:pointer; font-weight:750;
    }
    .btn:hover{border-color: rgba(95,179,255,.35); background: rgba(22,33,50,.95)}
    .btn.ok{border-color: rgba(85,211,138,.45); background: rgba(85,211,138,.12)}
    .btn.danger{border-color: rgba(255,107,107,.45); background: rgba(255,107,107,.10)}
    .btn.secondary{color:var(--muted); font-weight:750}
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px; border-radius: 999px;
      border:1px solid rgba(33,48,66,.9);
      background: rgba(22,33,50,.6);
      color:var(--text);
      font-weight:750;
    }
    .invgrid{display:grid; grid-template-columns: repeat(3, 1fr); gap:10px}
    @media (max-width: 520px){ .invgrid{grid-template-columns: repeat(2, 1fr);} }
    .cell{
      border:1px solid rgba(33,48,66,.9);
      background: rgba(8,12,18,.55);
      border-radius: 14px;
      padding:10px;
      display:flex; gap:10px; align-items:center; justify-content:space-between;
    }
    .left{display:flex; gap:10px; align-items:center}
    .emo{font-size:18px}
    .name{color:var(--muted); font-weight:750; font-size:12px}
    .log{
      white-space:pre-wrap;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size:12px;
      background: rgba(8,12,18,.65);
      border:1px solid rgba(33,48,66,.9);
      border-radius: 14px;
      padding:10px;
      max-height:260px;
      overflow:auto;
    }
    .hint{color:var(--muted); font-size:12px}
    .split2{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    @media (max-width: 820px){ .split2{grid-template-columns:1fr} }
    footer{margin-top:12px; color:var(--muted); font-size:12px}
  
    .fab{
      position: fixed;
      right: 14px;
      bottom: 14px;
      z-index: 50;
      width: 52px;
      height: 52px;
      border-radius: 999px;
      border:1px solid rgba(95,179,255,.45);
      background: rgba(95,179,255,.14);
      color: var(--text);
      box-shadow: var(--shadow);
      cursor:pointer;
      font-weight: 900;
      font-size: 18px;
    }
    .fab:hover{ background: rgba(95,179,255,.22); }

    .modal{ position: fixed; inset:0; z-index:60; display:none; }
    .modal.open{ display:block; }
    .modal__backdrop{ position:absolute; inset:0; background: rgba(0,0,0,.55); }
    .modal__panel{
      position: relative;
      max-width: 860px;
      margin: 8vh auto 0;
      background: linear-gradient(180deg, rgba(16,24,35,.96), rgba(15,22,32,.96));
      border:1px solid rgba(33,48,66,.9);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .modal__head{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding: 12px 14px;
      border-bottom:1px solid rgba(33,48,66,.6);
    }
    .modal__title{ font-weight: 900; }
    .modal__sub{ color: var(--muted); font-size: 12px; margin-top:2px; }
    .modal__body{ padding: 14px; }
    .memo{ max-height: 52vh; }

    details.acc{
      border:1px solid rgba(33,48,66,.75);
      background: rgba(8,12,18,.40);
      border-radius: 14px;
      padding: 10px 10px;
      margin-top: 10px;
    }
    details.acc > summary{
      cursor:pointer;
      font-weight: 900;
      color: var(--text);
      list-style: none;
      outline:none;
    }
    details.acc > summary::-webkit-details-marker{ display:none; }
    .acc__body{ padding: 10px 2px 2px; }

  </style>
</head>
<body>
<div class="wrap">
  <header>
    <div>
      <h1>–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä + –ø—Ä–∞–≤–∏–ª–∞ –∏–≥—Ä—ã</h1>
      <div class="sub">–û–¥–∏–Ω —Ñ–∞–π–ª –¥–ª—è GitHub Pages: –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä, –ø–∞—Ä—Å–µ—Ä –ø–æ—Å—Ç–æ–≤ A/B, –ø—Ä–∞–≤–∏–ª–∞ –∏ –º–µ—Å—Ç–æ –ø–æ–¥ –±–∞–∑—É –∫–∞—Ä—Ç. –ü—Ä–æ—Ñ–∏–ª–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ (localStorage).</div>
    </div>
  </header>


  <!-- Always-available memo -->
  <button class="fab" id="memoBtn" aria-label="–ü–∞–º—è—Ç–∫–∞">üìå</button>

  <div class="modal" id="memoModal" aria-hidden="true">
    <div class="modal__backdrop" data-close="1"></div>
    <div class="modal__panel" role="dialog" aria-modal="true" aria-labelledby="memoTitle">
      <div class="modal__head">
        <div>
          <div class="modal__title" id="memoTitle">üìå –ü–∞–º—è—Ç–∫–∞ –∏–≥—Ä–æ–∫–∞</div>
          <div class="modal__sub">–í—Å–µ–≥–¥–∞ –¥–æ—Å—Ç—É–ø–Ω–æ –∏–∑ –ª—é–±–æ–≥–æ —Ä–∞–∑–¥–µ–ª–∞</div>
        </div>
        <button class="btn secondary" data-close="1">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
      <div class="modal__body">
        <div class="log memo" id="memoText"></div>
      </div>
    </div>
  </div>


  <div class="grid">

    <section class="card" id="calc">
      <h2>
        <span>üßÆ –ü–µ—Å–æ—á–Ω–∏—Ü–∞</span>
        <span class="row">
          <select id="src" title="–ü—Ä–æ—Ñ–∏–ª—å">
            <option value="sandbox">–ü–µ—Å–æ—á–Ω–∏—Ü–∞</option>
          </select>
          <button class="btn secondary" id="load">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
          <button class="btn secondary" id="save">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </span>
      </h2>
      <div class="body">
        <div class="row">
          <div style="flex:1; min-width:260px">
            <label>–ë—ã—Å—Ç—Ä—ã–π –≤–≤–æ–¥ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
            <div class="row">
              <input id="quick" type="text" placeholder="–ù–∞–ø—Ä.: ‚òëÔ∏è7 üü¶2 üü©1 ‚¨úÔ∏è1 üîò3 üßø1 üö®1"/>
              <button class="btn" id="quickApply">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
            </div>
            <div class="hint">–≠–º–æ–¥–∑–∏+—á–∏—Å–ª–æ –≤ –ª—é–±–æ–º –ø–æ—Ä—è–¥–∫–µ.</div>
          </div>
        </div>

        <div class="row">
          <div style="flex:1">
            <label>–†–µ—Å—É—Ä—Å—ã</label>
            <div class="invgrid" id="inv"></div>
          </div>
        </div>

        <div class="row">
          <button class="btn ok" id="up">‚¨ÜÔ∏è –°–æ–±—Ä–∞—Ç—å (–ª–µ—Å—Ç–Ω–∏—Ü–∞)</button>
          <button class="btn" id="down">‚¨áÔ∏è –†–∞–∑–æ–±—Ä–∞—Ç—å (–ª–µ—Å—Ç–Ω–∏—Ü–∞)</button>
          <button class="btn" id="split">üîò –†–∞–∑–¥–µ–ª–∏—Ç—å ‚òëÔ∏è‚Üíüîò√ó2</button>
          <button class="btn" id="tv">üßø –¢–í: ‚¨úÔ∏è+üîò‚Üíüßø</button>
          <button class="btn danger" id="reset">–°–±—Ä–æ—Å</button>
        </div>

        <div class="row">
          <span class="pill">–≠–∫–≤–∏–≤–∞–ª–µ–Ω—Ç: <span id="eq">0</span> ‚òëÔ∏è</span>
          <span class="pill">–õ–µ—Å—Ç–Ω–∏—Ü–∞: <span id="lad">‚Äî</span></span>
          <span class="pill">–°–µ–π—á–∞—Å: <span id="short">‚Äî</span></span>
        </div>

        <div class="row">
          <div style="flex:1; min-width:260px">
            <label>–õ–æ–≥</label>
            <div class="log" id="log">‚Äî</div>
          </div>
        </div>

        <div class="hint">–ö–æ–º–∏—Å—Å–∏—é –Ω—É–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å –≤ —á–∞—Ç–µ –±–∞–Ω–∫–∞. –¢–í: üîò —Å–≥–æ—Ä–∞–µ—Ç –ø—Ä–∏ —Å–±–æ—Ä–∫–µ/—Ä–∞–∑–±–æ—Ä–∫–µ.</div>
      </div>
    </section>

    <section class="card" id="parser">
      <h2>
        <span>üßæ –í—Å—Ç–∞–≤—å –ø–æ—Å—Ç—ã A + B (—Ç–µ–∫—Å—Ç–æ–º) ‚Üí –∞–Ω–∞–ª–∏–∑ ‚Üí –ø—Ä–æ—Ñ–∏–ª–∏</span>
        <span class="row">
          <button class="btn ok" id="parse">–†–∞–∑–æ–±—Ä–∞—Ç—å</button>
          <button class="btn secondary" id="toProfiles">–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª–∏</button>
          <button class="btn danger" id="clear">–û—á–∏—Å—Ç–∏—Ç—å</button>
        </span>
      </h2>
      <div class="body">
        <div class="split2">
          <div>
            <label>Post A</label>
            <textarea id="pa" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ Post A —Ü–µ–ª–∏–∫–æ–º"></textarea>
          </div>
          <div>
            <label>Post B</label>
            <textarea id="pb" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ Post B —Ü–µ–ª–∏–∫–æ–º"></textarea>
          </div>
        </div>

        <div class="row">
          <span class="pill">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: <span id="pUsers">0</span></span>
          <span class="pill">–í—Å–µ–≥–æ –∫–∞—Ä—Ç (–±–∞–∑–∞): <span id="pTotalCards">0</span></span>
          <span class="pill">–û–±—â–∞—è —Ü–µ–Ω–Ω–æ—Å—Ç—å: <span id="pTotalGray">0</span> ‚òëÔ∏è</span>
        </div>

        <div class="row">
          <div style="flex:1; min-width:260px">
            <label>–†–∞–∑–±–æ—Ä (–ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º)</label>
            <div class="log" id="pOut">‚Äî</div>
          </div>
        </div>

        <div class="row">
          <div style="flex:1; min-width:260px">
            <label>–¢–æ–ø-10 –ø–æ —Ü–µ–Ω–Ω–æ—Å—Ç–∏</label>
            <div class="log" id="pTop">‚Äî</div>
          </div>
        </div>

        <div class="hint">
          –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è —Ç–∞–±–ª–∏—á–Ω—ã–π –≤—ã–≤–æ–¥ —Å <b>‚îÇ</b>/<b>|</b> –∏ —Å—Ç—Ä–æ–∫–∏ –≤–∏–¥–∞ ¬´–ò–º—è ‚òëÔ∏è14 üü¶1 ‚Ä¶¬ª.
          –í –ø—Ä–æ—Ñ–∏–ª–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è —Ç–æ–ª—å–∫–æ: ‚òëÔ∏è üü¶ üü© ‚¨úÔ∏è üüß üíé üö® üîò üßø.
        </div>
      </div>
    </section>


    <section class="card" id="rules">
      <h2>
        <span>üìö –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞</span>
        <span class="row">
          <button class="btn secondary" id="memoBtn2">üìå –ü–∞–º—è—Ç–∫–∞</button>
        </span>
      </h2>
      <div class="body">
        <div class="hint">–≠—Ç–æ —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è –ø—Ä–∞–≤–∏–ª. –ö—Ä–∞—Ç–∫–∞—è –ø–∞–º—è—Ç–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ –ø–æ –∫–Ω–æ–ø–∫–µ üìå –∏ –≤–≤–µ—Ä—Ö—É —ç–∫—Ä–∞–Ω–∞.</div>

        <details open class="acc">
          <summary>üéØ –û—Å–Ω–æ–≤–Ω–∞—è –∫–æ–Ω—Ü–µ–ø—Ü–∏—è</summary>
          <div class="acc__body">
            <div class="hint">
              –ò–≥—Ä–∞ –ø—Ä–æ—Ö–æ–¥–∏—Ç –≤ —Ä–∞–º–∫–∞—Ö –æ–Ω–ª–∞–π–Ω-—Å—Ç—Ä–∏–º–æ–≤. –ò–≥—Ä–æ–∫–∏ –ø–æ–ª—É—á–∞—é—Ç –∫–∞—Ä—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ–∑–≤–æ–ª—è—é—Ç: –Ω–∞–∫–∞–∑—ã–≤–∞—Ç—å/–∑–∞—â–∏—â–∞—Ç—å—Å—è, –≤–ª–∏—è—Ç—å –Ω–∞ —ç—Ñ–∏—Ä, —Å—Ç—Ä–æ–∏—Ç—å –±–∞–Ω–∫–∏/—Ö—Ä–∞–º—ã, –∫–æ–Ω–∫—É—Ä–∏—Ä–æ–≤–∞—Ç—å –∏ —Å–æ—Ç—Ä—É–¥–Ω–∏—á–∞—Ç—å. –ö–∞—Ä—Ç—ã –º–æ–∂–Ω–æ –ø–æ–ª—É—á–∞—Ç—å, —Å–æ–±–∏—Ä–∞—Ç—å, –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å, –ø–æ–∫—É–ø–∞—Ç—å –∏ —Ç–µ—Ä—è—Ç—å.
            </div>
          </div>
        </details>

        <details class="acc">
          <summary>üßæ –û—Å–Ω–æ–≤–Ω—ã–µ —Ç–∏–ø—ã –∫–∞—Ä—Ç</summary>
          <div class="acc__body">
            <div class="log">
1) –û–±—ã—á–Ω—ã–µ (üÄÑÔ∏è): üü¶ üü© ‚¨úÔ∏è üüß üíé ‚Äî —Å–Ω—è—Ç–∏–µ –Ω–∞—Ä—É—à–µ–Ω–∏–π / –º–æ–¥–µ—Ä–∞—Ü–∏—è / –ø—Ä–æ–¥–ª–µ–Ω–∏–µ
2) –ê–∫—Ç–∏–≤–∞—Ü–∏–∏ (üé¥): üÉè ‚òÆÔ∏è üö® ‚ìÇÔ∏è ‚ôéÔ∏è ‚Äî –±–∞—Ç–ª—ã / –∏–º–º—É–Ω–∏—Ç–µ—Ç—ã / –∫—Ä–∞–∂–∏ / –≥–ª–æ–±–∞–ª—å–Ω—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã
3) –ù–∞—Ä—É—à–µ–Ω–∏—è (üßß): üü™ üü® üü• ‚¨õÔ∏è üü´ ‚Äî –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è / –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è / –±–∞–Ω—ã
4) –û–ø–∞—Å–Ω—ã–µ (üì±): ‚ö´Ô∏è üí£ üåã ü•∑ ‚Äî –∂—ë—Å—Ç–∫–∏–µ —ç—Ñ—Ñ–µ–∫—Ç—ã (–æ–±–Ω—É–ª–µ–Ω–∏–µ/—É–Ω–∏—á—Ç–æ–∂–µ–Ω–∏–µ/–∫—Ä–∞–∂–∏)
5) –°—É–ø–µ—Ä-–∫–∞—Ä—Ç—ã (ü™ü): üè≥Ô∏è‚Äçüåà üèß üõê ü™Ω üé∞ ‚Äî –∏–º–º—É–Ω–∏—Ç–µ—Ç—ã / –≥–µ–Ω–µ—Ä–∞—Ü–∏—è / –∑–∞—â–∏—Ç–∞ / –∫—Ä—É–ø–Ω—ã–µ –±–æ–Ω—É—Å—ã
6) –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã: üßø ‚≠ïÔ∏è üé≤ ‚ô¶Ô∏è ‚Äî –∫–æ–ª—ë—Å–∞ –∏ –º–Ω–æ–∂–∏—Ç–µ–ª–∏
            </div>
          </div>
        </details>

        <details class="acc">
          <summary>‚úÖ –ö–∞–∫ –ø–æ–ª—É—á–∏—Ç—å –∫–∞—Ä—Ç—ã</summary>
          <div class="acc__body">
            <div class="log">
‚Äî –î–æ–Ω–∞—Ç (–ø—Ä–æ–¥–ª–µ–Ω–∏–µ —ç—Ñ–∏—Ä–∞): —Ç–æ–ø-5 –¥–æ–Ω–∞—Ç–µ—Ä–æ–≤ –ø–æ–ª—É—á–∞—é—Ç –∫–∞—Ä—Ç—ã –∫–∞–∂–¥—ã–µ 3 —á–∞—Å–∞ –ø—Ä–æ–¥–ª–µ–Ω–∏—è
‚Äî –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å: —Ç–æ–ø –ø–æ –ø—Ä–æ—Å–º–æ—Ç—Ä—É / –±–∞—Ç–ª–∞–º / –ª–∏–≥–∞–º
‚Äî –ö–æ–ª—ë—Å–∞: üßø –¢–í (–¥–æ 3 –≤ –¥–µ–Ω—å), ‚≠ïÔ∏è –∫–æ–ª–µ—Å–æ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ (1 –≤ –¥–µ–Ω—å)
‚Äî –°–±–æ—Ä–∫–∞: –∫–æ–º–±–∏–Ω–∏—Ä—É–π –∫–∞—Ä—Ç—ã, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –±–æ–ª–µ–µ —Å–∏–ª—å–Ω—ã–µ
‚Äî –ü–æ–∫—É–ø–∫–∞/–≤—ã–¥–∞—á–∞ –≤–µ–¥—É—â–∏–º: —Å–æ–±—ã—Ç–∏—è, —Ñ–ª–µ—à–º–æ–±—ã, —Ä–µ–∞–ª—å–Ω—ã–µ –¥–µ–Ω—å–≥–∏
            </div>
          </div>
        </details>

        <details class="acc">
          <summary>‚ö†Ô∏è –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –∏ –ª–∏–º–∏—Ç—ã</summary>
          <div class="acc__body">
            <div class="log">
‚Äî –ù–µ–ª—å–∑—è –Ω–∞–∫–∞–∑—ã–≤–∞—Ç—å: —Ç–æ–ø-3 —Å–ø–æ–Ω—Å–æ—Ä–æ–≤, –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–æ–≤, –∏–≥—Ä–æ–∫–æ–≤ —Å –∞–∫—Ç–∏–≤–Ω–æ–π –∑–∞—â–∏—Ç–æ–π
‚Äî –õ–∏–º–∏—Ç—ã –ø–µ—Ä–µ–¥–∞—á: 7 –∫–∞—Ä—Ç –∏ 7 üßø –≤ –¥–µ–Ω—å (–æ–±—â–∏–π), 3 –∫–∞—Ä—Ç—ã –∏ 3 üßø –Ω–∞ –∏–≥—Ä–æ–∫–∞; üßø –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è –±–µ–∑ –∫–æ–º–∏—Å—Å–∏–∏
‚Äî –õ–∏–º–∏—Ç –∞–∫—Ç–∏–≤–∞—Ü–∏–π: –Ω–µ –±–æ–ª–µ–µ 3 –∫–∞—Ä—Ç –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –≤ –¥–µ–Ω—å
‚Äî –°–≥–æ—Ä–∞–Ω–∏–µ: –∫–∞—Ä—Ç—ã –º–æ–≥—É—Ç —Å–≥–æ—Ä–∞—Ç—å –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –ø—Ä–æ–¥–ª–µ–Ω–∏—è (–µ—Å–ª–∏ —Ç–∞–∫–æ–µ –ø—Ä–∞–≤–∏–ª–æ –≤–∫–ª—é—á–µ–Ω–æ –≤–µ–¥—É—â–∏–º)
‚Äî –ê–≤–∞—Ç–∞—Ä–∫–∞: –¥–ª—è –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –∫–∞—Ä—Ç —ç—Ñ—Ñ–µ–∫—Ç –∞–∫—Ç–∏–≤–µ–Ω —Ç–æ–ª—å–∫–æ –ø–æ–∫–∞ –∫–∞—Ä—Ç–∞ —Å—Ç–æ–∏—Ç –Ω–∞ –∞–≤–∞—Ç–∞—Ä–∫–µ
            </div>
          </div>
        </details>

        <details class="acc">
          <summary>üõ°Ô∏è –ó–∞—â–∏—Ç–∞ –∏ –∏–º–º—É–Ω–∏—Ç–µ—Ç—ã</summary>
          <div class="acc__body">
            <div class="log">
üè≥Ô∏è‚Äçüåà –†–∞–¥—É–∂–Ω–∞—è ‚Äî –∏–º–º—É–Ω–∏—Ç–µ—Ç –∫ –∫–∞—Ä—Ç–∞–º –Ω–∞—Ä—É—à–µ–Ω–∏–π –Ω–∞ –Ω–µ–¥–µ–ª—é (–∫—Ä–æ–º–µ –≤–µ–¥—É—â–µ–≥–æ)
‚òÆÔ∏è –ü–∞—Ü–∏—Ñ–∏–∫ ‚Äî —Å–Ω–∏–º–∞–µ—Ç üü´ –∏ üü•, –∏–º–º—É–Ω–∏—Ç–µ—Ç –∫ –Ω–∏–º –Ω–∞ 24 —á–∞—Å–∞
ü™Ω –ê–Ω–≥–µ–ª ‚Äî –ø–æ–ª–Ω—ã–π –∏–º–º—É–Ω–∏—Ç–µ—Ç + –º–æ–∂–µ—Ç —Å–Ω–∏–º–∞—Ç—å –Ω–∞—Ä—É—à–µ–Ω–∏—è —Å –¥—Ä—É–≥–∏—Ö
üõê –•—Ä–∞–º / üèß –ë–∞–Ω–∫ / üóÑ –°–µ–π—Ñ ‚Äî –∑–∞—â–∏—Ç–Ω—ã–µ –º–µ—Ö–∞–Ω–∏–∫–∏ –¥–ª—è –∞–∫—Ç–∏–≤–æ–≤/–∫–∞—Ä—Ç
            </div>
          </div>
        </details>

        <details class="acc">
          <summary>üéØ –°—Ç—Ä–∞—Ç–µ–≥–∏—è –Ω–æ–≤–∏—á–∫–∞ (–∫–æ—Ä–æ—Ç–∫–æ)</summary>
          <div class="acc__body">
            <div class="log">
1) –ù–∞—á–Ω–∏ —Å –º–∞–ª–æ–≥–æ: –ø—Ä–æ–¥–ª–µ–≤–∞–π —ç—Ñ–∏—Ä / –∫—Ä—É—Ç–∏ üßø
2) –°–æ–±–∏—Ä–∞–π –∑–∞—â–∏—Ç—É: 3‚òëÔ∏è=üü¶, 2üü¶=üü©, 2üü©=‚¨úÔ∏è
3) –ù–µ —Ç—Ä–∞—Ç—å –æ–ø–∞—Å–Ω—ã–µ –∫–∞—Ä—Ç—ã –±–µ–∑ –ø–æ–Ω–∏–º–∞–Ω–∏—è
4) –°–ø—Ä–∞—à–∏–≤–∞–π —É –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–æ–≤/–≤–µ–¥—É—â–µ–≥–æ
            </div>
          </div>
        </details>
      </div>
    </section>

    <section class="card" id="cardsdb">
      <h2>
        <span>üóÇÔ∏è –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ –∫–∞—Ä—Ç–∞–º</span>
        <span class="row">
          <span class="pill">–°–∫–æ—Ä–æ</span>
        </span>
      </h2>
      <div class="body">
        <div class="hint">
          –ó–¥–µ—Å—å –±—É–¥–µ—Ç —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫ –ø–æ –≤—Å–µ–º –∫–∞—Ä—Ç–∞–º: –æ–ø–∏—Å–∞–Ω–∏–µ, —Ç–∏–ø, —ç—Ñ—Ñ–µ–∫—Ç—ã, —Å—Ç–æ–∏–º–æ—Å—Ç—å –≤ ‚òëÔ∏è, —Ä–µ—Ü–µ–ø—Ç—ã —Å–±–æ—Ä–∫–∏/—Ä–∞–∑–±–æ—Ä–∫–∏ –∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è.
        </div>
        <div class="row">
          <div style="flex:1; min-width:260px">
            <label>–ü–æ–∏—Å–∫ (–∑–∞–≥–æ—Ç–æ–≤–∫–∞)</label>
            <input type="text" placeholder="–ù–∞–ø—Ä.: –î–∂–æ–∫–µ—Ä, –ë–∞–Ω–∫, üßø, üö®" disabled />
          </div>
        </div>
        <div class="log">–†–∞–∑–¥–µ–ª –∑–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω –ø–æ–¥ —Å–ª–µ–¥—É—é—â—É—é –∏—Ç–µ—Ä–∞—Ü–∏—é.</div>
      </div>
    </section>


    <footer>–õ–æ–∫–∞–ª—å–Ω–æ, –±–µ–∑ —Å–µ—Ä–≤–µ—Ä–∞. –î–ª—è GitHub Pages –ø—Ä–æ—Å—Ç–æ –ø–æ–ª–æ–∂–∏—Ç–µ —Ñ–∞–π–ª –∫–∞–∫ index.html.</footer>
  </div>
</div>

<script>
(function(){
  "use strict";

  const MEMO = '‚Äî –í—Å—ë —Å—á–∏—Ç–∞–µ—Ç—Å—è –≤ ‚òëÔ∏è (—Å–µ—Ä—ã—Ö)\n‚Äî –õ–µ—Å—Ç–Ω–∏—Ü–∞ –≤–∞–ª—é—Ç:\n  ‚òëÔ∏è(1) ‚Üí üü¶(3) ‚Üí üü©(6) ‚Üí ‚¨úÔ∏è(12) ‚Üí üüß(24) ‚Üí üíé(48) ‚Üí üö®(144)\n  (3 ‚òëÔ∏è = üü¶ ¬∑ 2 üü¶ = üü© ¬∑ 2 üü© = ‚¨úÔ∏è ¬∑ 2 ‚¨úÔ∏è = üüß ¬∑ 2 üüß = üíé ¬∑ 3 üíé = üö®)\n‚Äî üîò –ö–æ–º–∏—Å—Å–∏—è –Ω—É–∂–Ω–∞ –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ –∫–∞—Ä—Ç –∏ –¢–í, –≤—ã–¥–∞—ë—Ç —Ç–æ–ª—å–∫–æ –ë–∞–Ω–∫, üîò —Å–≥–æ—Ä–∞–µ—Ç\n‚Äî üßø –¢–í: ‚¨úÔ∏è + üîò ‚Üí üßø | –¢–í –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è –±–µ–∑ –∫–æ–º–∏—Å—Å–∏–∏\n‚Äî –õ–∏–º–∏—Ç—ã: 3 –∞–∫—Ç–∏–≤–∞—Ü–∏–∏/–¥–µ–Ω—å ¬∑ –ø–µ—Ä–µ–¥–∞—á–∞: 3 –∫–∞—Ä—Ç—ã + 3 üßø –Ω–∞ –∏–≥—Ä–æ–∫–∞, 7/7 –≤—Å–µ–≥–æ\n‚Äî –ü–µ—Ä–µ–¥–∞—á–∞: –í–ò–ü —á–∞—Ç / –û–±—â–∏–π —á–∞—Ç / –õ–° –≤–µ–¥—É—â–µ–º—É\n‚Äî –°–±–æ—Ä–∫–∞/—Ä–∞–∑–±–æ—Ä–∫–∞: –≤—Å–µ–≥–¥–∞ –ø–∏—à–∏—Ç–µ, —á—Ç–æ –∏–∑ —á–µ–≥–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ —Å–æ–±–∏—Ä–∞–µ—Ç–µ/—Ä–∞–∑–±–∏—Ä–∞–µ—Ç–µ\n\nüëâ –î—É–º–∞–π –≤ ‚òëÔ∏è ‚Äî –æ—Å—Ç–∞–ª—å–Ω–æ–µ –≤—Ç–æ—Ä–∏—á–Ω–æ';

  // ---------- Constants ----------
  const META = {
    gray:{e:"‚òëÔ∏è", n:"–°–µ—Ä–∞—è"}, blue:{e:"üü¶", n:"–°–∏–Ω—è—è"}, green:{e:"üü©", n:"–ó–µ–ª—ë–Ω–∞—è"}, white:{e:"‚¨úÔ∏è", n:"–ë–µ–ª–∞—è"},
    gold:{e:"üüß", n:"–ó–æ–ª–æ—Ç–∞—è"}, emerald:{e:"üíé", n:"–ò–∑—É–º—Ä—É–¥–Ω–∞—è"}, ruby:{e:"üö®", n:"–†—É–±–∏–Ω–æ–≤–∞—è"},
    fee:{e:"üîò", n:"–ö–æ–º–∏—Å—Å–∏—è"}, tv:{e:"üßø", n:"–¢–í –∫–æ–ª–µ—Å–æ"},
  };
  const QUICK = ["gray","blue","green","white","gold","emerald","ruby","fee","tv"];
  const EMOJI_TO_ID = (function(){
    const m = Object.create(null);
    for (const [id, v] of Object.entries(META)) m[v.e] = id;
    m["‚¨ú"] = "white";
    return m;
  })();

  const LS_KEY = "cards_profiles_v1";

  // ---------- Helpers ----------
  const $ = (sel, root=document) => root.querySelector(sel);
  function clamp0(n){ n=Number(n); if(!Number.isFinite(n)) return 0; return Math.max(0, Math.floor(n)); }
  function cloneInv(inv){ const o=Object.create(null); for(const k of Object.keys(inv||{})){ const v=clamp0(inv[k]); if(v) o[k]=v; } return o; }
  function getNum(inv,id){ return clamp0(inv && inv[id]); }
  function setNum(inv,id,v){ inv[id]=clamp0(v); if(!inv[id]) delete inv[id]; }
  function normalizeName(name){ return String(name||"").replace(/\s+/g," ").trim(); }

  function sbGrayValue(inv){
    const g = Number(inv.gray||0), b = Number(inv.blue||0), gr = Number(inv.green||0);
    const w = Number(inv.white||0), go = Number(inv.gold||0), e = Number(inv.emerald||0), r = Number(inv.ruby||0);
    return g + b*3 + gr*6 + w*12 + go*24 + e*48 + r*144;
  }
  function ladderFromGray(grayTotal){
    let t = Math.max(0, Math.floor(Number(grayTotal)||0));
    const out = { ruby:0, emerald:0, gold:0, white:0, green:0, blue:0, gray:0 };
    out.ruby = Math.floor(t / 144); t %= 144;
    out.emerald = Math.floor(t / 48); t %= 48;
    out.gold = Math.floor(t / 24); t %= 24;
    out.white = Math.floor(t / 12); t %= 12;
    out.green = Math.floor(t / 6); t %= 6;
    out.blue = Math.floor(t / 3); t %= 3;
    out.gray = t;
    return out;
  }
  function fmtLadder(l){
    const parts = [];
    if (l.ruby) parts.push(`üö®${l.ruby}`);
    if (l.emerald) parts.push(`üíé${l.emerald}`);
    if (l.gold) parts.push(`üüß${l.gold}`);
    if (l.white) parts.push(`‚¨úÔ∏è${l.white}`);
    if (l.green) parts.push(`üü©${l.green}`);
    if (l.blue) parts.push(`üü¶${l.blue}`);
    if (l.gray) parts.push(`‚òëÔ∏è${l.gray}`);
    return parts.length ? parts.join(" ") : "‚Äî";
  }
  function fmtInvShort(inv){
    const parts=[];
    for (const id of QUICK){
      const v = clamp0(inv && inv[id]);
      if (v) parts.push(`${META[id].e}${v}`);
    }
    return parts.length ? parts.join(" ") : "‚Äî";
  }

  // ---------- Core actions (–∫–∞–∫ –≤ –≤–æ—Ä–∫–µ—Ä–µ) ----------
  function craftUp(inv0){
    const inv = Object.assign(Object.create(null), inv0);
    const log = [];
    let k = Math.floor(getNum(inv,"gray") / 3);
    if (k){ setNum(inv,"gray", getNum(inv,"gray") - 3*k); setNum(inv,"blue", getNum(inv,"blue") + k); log.push(`‚òëÔ∏è√ó${3*k} ‚Üí üü¶√ó${k}`); }
    k = Math.floor(getNum(inv,"blue") / 2);
    if (k){ setNum(inv,"blue", getNum(inv,"blue") - 2*k); setNum(inv,"green", getNum(inv,"green") + k); log.push(`üü¶√ó${2*k} ‚Üí üü©√ó${k}`); }
    k = Math.floor(getNum(inv,"green") / 2);
    if (k){ setNum(inv,"green", getNum(inv,"green") - 2*k); setNum(inv,"white", getNum(inv,"white") + k); log.push(`üü©√ó${2*k} ‚Üí ‚¨úÔ∏è√ó${k}`); }
    k = Math.floor(getNum(inv,"white") / 2);
    if (k){ setNum(inv,"white", getNum(inv,"white") - 2*k); setNum(inv,"gold", getNum(inv,"gold") + k); log.push(`‚¨úÔ∏è√ó${2*k} ‚Üí üüß√ó${k}`); }
    k = Math.floor(getNum(inv,"gold") / 2);
    if (k){ setNum(inv,"gold", getNum(inv,"gold") - 2*k); setNum(inv,"emerald", getNum(inv,"emerald") + k); log.push(`üüß√ó${2*k} ‚Üí üíé√ó${k}`); }
    k = Math.floor(getNum(inv,"emerald") / 3);
    if (k){ setNum(inv,"emerald", getNum(inv,"emerald") - 3*k); setNum(inv,"ruby", getNum(inv,"ruby") + k); log.push(`üíé√ó${3*k} ‚Üí üö®√ó${k}`); }
    return { inv, log: log.length ? log : ["–ù–µ—á–µ–≥–æ —Å–æ–±–∏—Ä–∞—Ç—å."] };
  }

  function breakDown(inv0){
    const inv = Object.assign(Object.create(null), inv0);
    const log = [];

    // TV breakdown requires fee and burns it
    let k = Math.min(getNum(inv,"tv"), getNum(inv,"fee"));
    if (k){
      setNum(inv,"tv", getNum(inv,"tv") - k);
      setNum(inv,"fee", getNum(inv,"fee") - k);
      setNum(inv,"white", getNum(inv,"white") + k);
      log.push(`üßø√ó${k} + üîò√ó${k} ‚Üí ‚¨úÔ∏è√ó${k} (üîò —Å–≥–æ—Ä–∞–µ—Ç)`);
    }

    k = getNum(inv,"ruby");
    if (k){ setNum(inv,"ruby",0); setNum(inv,"emerald", getNum(inv,"emerald") + 3*k); log.push(`üö®√ó${k} ‚Üí üíé√ó${3*k}`); }
    k = getNum(inv,"emerald");
    if (k){ setNum(inv,"emerald",0); setNum(inv,"gold", getNum(inv,"gold") + 2*k); log.push(`üíé√ó${k} ‚Üí üüß√ó${2*k}`); }
    k = getNum(inv,"gold");
    if (k){ setNum(inv,"gold",0); setNum(inv,"white", getNum(inv,"white") + 2*k); log.push(`üüß√ó${k} ‚Üí ‚¨úÔ∏è√ó${2*k}`); }
    k = getNum(inv,"white");
    if (k){ setNum(inv,"white",0); setNum(inv,"green", getNum(inv,"green") + 2*k); log.push(`‚¨úÔ∏è√ó${k} ‚Üí üü©√ó${2*k}`); }
    k = getNum(inv,"green");
    if (k){ setNum(inv,"green",0); setNum(inv,"blue", getNum(inv,"blue") + 2*k); log.push(`üü©√ó${k} ‚Üí üü¶√ó${2*k}`); }
    k = getNum(inv,"blue");
    if (k){ setNum(inv,"blue",0); setNum(inv,"gray", getNum(inv,"gray") + 3*k); log.push(`üü¶√ó${k} ‚Üí ‚òëÔ∏è√ó${3*k}`); }

    return { inv, log: log.length ? log : ["–ù–µ—á–µ–≥–æ —Ä–∞–∑–±–∏—Ä–∞—Ç—å."] };
  }

  function splitGray(inv0){
    const inv = Object.assign(Object.create(null), inv0);
    const k = getNum(inv,"gray");
    const log=[];
    if (k){ setNum(inv,"gray", 0); setNum(inv,"fee", getNum(inv,"fee") + 2*k); log.push(`‚òëÔ∏è√ó${k} ‚Üí üîò√ó${2*k}`); }
    return { inv, log: log.length ? log : ["–ù–µ—Ç ‚òëÔ∏è –¥–ª—è —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è."] };
  }

  function craftTv(inv0){
    const inv = Object.assign(Object.create(null), inv0);
    const k = Math.min(getNum(inv,"white"), getNum(inv,"fee"));
    const log=[];
    if (k){
      setNum(inv,"white", getNum(inv,"white") - k);
      setNum(inv,"fee", getNum(inv,"fee") - k);
      setNum(inv,"tv", getNum(inv,"tv") + k);
      log.push(`‚¨úÔ∏è√ó${k} + üîò√ó${k} ‚Üí üßø√ó${k} (üîò —Å–≥–æ—Ä–∞–µ—Ç)`);
    }
    return { inv, log: log.length ? log : ["–ù—É–∂–Ω–æ ‚¨úÔ∏è –∏ üîò."] };
  }

  // ---------- Quick parse (emoji+number) ----------
  function escapeRegExp(str){ return String(str).replace(/[.*+?^${}()|[\]\\]/g, "\\$&"); }
  function parseEmojiCounts(text){
    const out = Object.create(null);
    const s = String(text || "");

    // Pass 1: explicit known emojis (handles multi-codepoint correctly)
    for (const [emo, id] of Object.entries(EMOJI_TO_ID)){
      const re = new RegExp(escapeRegExp(emo) + "\\s*(\\d{1,9})", "g");
      let m;
      while ((m = re.exec(s)) !== null){
        const n = clamp0(m[1]);
        out[id] = (out[id] || 0) + n;
      }
    }
    return out;
  }

  // ---------- Profiles storage ----------
  function loadProfiles(){
    const raw = localStorage.getItem(LS_KEY);
    if (!raw) return [];
    try{
      const arr = JSON.parse(raw);
      if (!Array.isArray(arr)) return [];
      return arr
        .map(x => (x && typeof x==="object") ? ({ name:String(x.name||"").trim(), inv: x.inv||{} }) : null)
        .filter(Boolean)
        .filter(x => x.name);
    }catch{ return []; }
  }
  function saveProfiles(list){
    const clean = list.map(p => ({ name:p.name, inv: cloneInv(p.inv||{}) }));
    localStorage.setItem(LS_KEY, JSON.stringify(clean));
  }
  function upsertProfile(name, inv){
    const n = normalizeName(name);
    if (!n) return;
    const ps = loadProfiles();
    const idx = ps.findIndex(p => p.name === n);
    const item = { name:n, inv: cloneInv(inv||{}) };
    if (idx === -1) ps.push(item);
    else ps[idx] = item;
    ps.sort((a,b)=>a.name.localeCompare(b.name,"ru",{numeric:true,sensitivity:"base"}));
    saveProfiles(ps);
  }
  function getProfile(name){
    const n = normalizeName(name);
    const ps = loadProfiles();
    return ps.find(p => p.name === n) || null;
  }

  // ---------- UI build ----------
  function buildInvGrid(rootEl, inv, onChange){
    rootEl.innerHTML = "";
    for (const id of QUICK){
      const cell = document.createElement("div");
      cell.className = "cell";
      const left = document.createElement("div");
      left.className = "left";
      const emo = document.createElement("div");
      emo.className = "emo";
      emo.textContent = META[id].e;
      const nm = document.createElement("div");
      nm.className = "name";
      nm.textContent = META[id].n;
      left.appendChild(emo); left.appendChild(nm);

      const input = document.createElement("input");
      input.type = "number";
      input.min = "0";
      input.step = "1";
      input.value = String(clamp0(inv[id] || 0));
      input.addEventListener("change", () => onChange(id, clamp0(input.value)));

      cell.appendChild(left);
      cell.appendChild(input);
      rootEl.appendChild(cell);
    }
  }

  function refreshProfilesSelect(){
    const sel = $("#src");
    const cur = sel.value || "sandbox";
    sel.innerHTML = "";
    const o0 = document.createElement("option");
    o0.value = "sandbox";
    o0.textContent = "–ü–µ—Å–æ—á–Ω–∏—Ü–∞";
    sel.appendChild(o0);

    const ps = loadProfiles();
    for (const p of ps){
      const o = document.createElement("option");
      o.value = "p:" + p.name;
      o.textContent = p.name;
      sel.appendChild(o);
    }
    if ([...sel.options].some(o=>o.value===cur)) sel.value = cur;
  }

  // ---------- Sandbox state ----------
  const sandbox = { inv: Object.create(null), log:"‚Äî" };

  function renderSandbox(){
    buildInvGrid($("#inv"), sandbox.inv, (id, val) => {
      setNum(sandbox.inv, id, val);
      sandbox.log = `–ò–∑–º–µ–Ω–µ–Ω–æ: ${META[id].e} ‚Üí ${val}`;
      renderAll();
    // preload memo text
    const mt = document.getElementById('memoText'); if (mt) mt.textContent = MEMO;
    });

    const eq = sbGrayValue(sandbox.inv);
    $("#eq").textContent = String(eq);
    $("#lad").textContent = fmtLadder(ladderFromGray(eq));
    $("#short").textContent = fmtInvShort(sandbox.inv);
    $("#log").textContent = sandbox.log || "‚Äî";
  }

  // ---------- Parser A/B ----------
  function stripCodeFences(s){
    s = String(s||"");
    return s.replace(/```[\s\S]*?```/g, (m)=>m.replace(/^```[^\n]*\n?/,"").replace(/```$/,""));
  }

  function parseUsersFromPosts(aText, bText){
    const text = (stripCodeFences(aText) + "\n" + stripCodeFences(bText)).replace(/\r/g,"");
    const lines = text.split("\n").map(x=>x.trim()).filter(Boolean);

    const users = Object.create(null);

    const tabRe = /^(.{1,64}?)\s*(?:\||‚îÇ)\s*(.+)$/u;

    for (const ln0 of lines){
      const ln = ln0
        .replace(/^–ö–∞—Ä—Ç—ã\s+—Å–ø–∏–∫–µ—Ä–æ–≤.*$/iu,"")
        .trim();
      if (!ln) continue;

      let name="", rest="";
      const m = ln.match(tabRe);
      if (m){
        name = normalizeName(m[1]);
        rest = m[2];
      } else {
        const hasAny = QUICK.some(id => ln.includes(META[id].e));
        if (!hasAny) continue;

        let idx = -1;
        for (const id of QUICK){
          const j = ln.indexOf(META[id].e);
          if (j !== -1) idx = (idx === -1) ? j : Math.min(idx, j);
        }
        if (idx === -1) continue;
        name = normalizeName(ln.slice(0, idx));
        rest = ln.slice(idx);
      }

      if (!name) continue;
      if (/^–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª/i.test(name) || /^–∏—Ç–æ–≥–æ/i.test(name) || /^total/i.test(name)) continue;

      const counts = parseEmojiCounts(rest);
      if (!Object.keys(counts).length) continue;

      if (!users[name]) users[name] = Object.create(null);
      for (const id of QUICK){
        if (counts[id] !== undefined){
          users[name][id] = (users[name][id] || 0) + counts[id];
        }
      }
    }

    const out = [];
    for (const [name, inv] of Object.entries(users)){
      out.push({ name, inv: cloneInv(inv) });
    }
    out.sort((a,b)=>a.name.localeCompare(b.name,"ru",{numeric:true,sensitivity:"base"}));
    return out;
  }

  function summarizeParsed(users){
    let totalCards = 0;
    let totalGray = 0;
    for (const u of users){
      for (const id of QUICK) totalCards += clamp0(u.inv[id] || 0);
      totalGray += sbGrayValue(u.inv);
    }
    const top = users
      .map(u => ({ name:u.name, gray: sbGrayValue(u.inv), inv:u.inv }))
      .sort((a,b)=>b.gray - a.gray || a.name.localeCompare(b.name,"ru",{numeric:true,sensitivity:"base"}))
      .slice(0, 10);
    return { totalCards, totalGray, top };
  }

  function formatUsersList(users){
    if (!users.length) return "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –≤ —Ç–µ–∫—Å—Ç–µ –µ—Å—Ç—å —Å—Ç—Ä–æ–∫–∏ —Å —ç–º–æ–¥–∑–∏ –∏ —á–∏—Å–ª–∞–º–∏.";
    const lines = [];
    for (const u of users){
      lines.push("‚Ä¢ " + u.name);
      lines.push("  " + fmtInvShort(u.inv));
    }
    return lines.join("\n");
  }
  function formatTop(top){
    if (!top.length) return "‚Äî";
    const lines = [];
    let i=1;
    for (const t of top){
      lines.push(String(i).padStart(2,"0") + ". " + t.name);
      lines.push("    " + "‚òëÔ∏è" + t.gray + " ¬∑ " + fmtInvShort(t.inv));
      i++;
    }
    return lines.join("\n");
  }

  let parsedCache = [];

  function doParse(){
    const users = parseUsersFromPosts($("#pa").value, $("#pb").value);
    parsedCache = users;
    const sum = summarizeParsed(users);

    $("#pUsers").textContent = String(users.length);
    $("#pTotalCards").textContent = String(sum.totalCards);
    $("#pTotalGray").textContent = String(sum.totalGray);
    $("#pOut").textContent = users.length ? formatUsersList(users) : "‚Äî";
    $("#pTop").textContent = formatTop(sum.top);
  }

  function toProfiles(){
    if (!parsedCache.length) doParse();
    if (!parsedCache.length){
      $("#pOut").textContent = "–°–Ω–∞—á–∞–ª–∞ —Ä–∞–∑–±–µ—Ä–∏—Ç–µ –ø–æ—Å—Ç—ã: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.";
      return;
    }
    for (const u of parsedCache){
      // keep only base keys
      const inv = Object.create(null);
      for (const id of QUICK){
        const v = clamp0(u.inv[id] || 0);
        if (v) inv[id] = v;
      }
      upsertProfile(u.name, inv);
    }
    refreshProfilesSelect();
    $("#pOut").textContent = $("#pOut").textContent + "\n\n‚úÖ –ü—Ä–æ—Ñ–∏–ª–∏ —Å–æ–∑–¥–∞–Ω—ã/–æ–±–Ω–æ–≤–ª–µ–Ω—ã.";
  }

  // ---------- Render all ----------
  function renderAll(){
    refreshProfilesSelect();
    renderSandbox();
  }

  // ---------- Events ----------
  $("#quickApply").addEventListener("click", () => {
    const parsed = parseEmojiCounts($("#quick").value);
    for (const id of QUICK){
      if (parsed[id] !== undefined) setNum(sandbox.inv, id, parsed[id]);
    }
    sandbox.log = "–ë—ã—Å—Ç—Ä—ã–π –≤–≤–æ–¥ –ø—Ä–∏–º–µ–Ω—ë–Ω.";
    renderAll();
  });

  $("#up").addEventListener("click", () => {
    const res = craftUp(sandbox.inv);
    sandbox.inv = res.inv;
    sandbox.log = res.log.join("\n");
    renderAll();
  });

  $("#down").addEventListener("click", () => {
    const res = breakDown(sandbox.inv);
    sandbox.inv = res.inv;
    sandbox.log = res.log.join("\n");
    renderAll();
  });

  $("#split").addEventListener("click", () => {
    const res = splitGray(sandbox.inv);
    sandbox.inv = res.inv;
    sandbox.log = res.log.join("\n");
    renderAll();
  });

  $("#tv").addEventListener("click", () => {
    const res = craftTv(sandbox.inv);
    sandbox.inv = res.inv;
    sandbox.log = res.log.join("\n");
    renderAll();
  });

  $("#reset").addEventListener("click", () => {
    sandbox.inv = Object.create(null);
    sandbox.log = "–°–±—Ä–æ—Å.";
    renderAll();
  });

  $("#parse").addEventListener("click", () => { doParse(); });
  $("#toProfiles").addEventListener("click", () => { toProfiles(); });
  $("#clear").addEventListener("click", () => {
    $("#pa").value = "";
    $("#pb").value = "";
    $("#pUsers").textContent = "0";
    $("#pTotalCards").textContent = "0";
    $("#pTotalGray").textContent = "0";
    $("#pOut").textContent = "‚Äî";
    $("#pTop").textContent = "‚Äî";
    parsedCache = [];

  // Memo (always available)
  function openMemo(){
    $("#memoText").textContent = MEMO;
    const m = $("#memoModal");
    m.classList.add("open");
    m.setAttribute("aria-hidden","false");
  }
  function closeMemo(){
    const m = $("#memoModal");
    m.classList.remove("open");
    m.setAttribute("aria-hidden","true");
  }
  $("#memoBtn").addEventListener("click", openMemo);
  const memoBtn2 = $("#memoBtn2");
  if (memoBtn2) memoBtn2.addEventListener("click", openMemo);
  $("#memoModal").addEventListener("click", (e) => {
    const t = e.target;
    if (t && t.getAttribute && t.getAttribute("data-close") === "1") closeMemo();
  });
  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape") closeMemo();
  });

  });

  $("#load").addEventListener("click", () => {
    const v = $("#src").value;
    if (v === "sandbox") return;
    if (!v.startsWith("p:")) return;
    const name = v.slice(2);
    const p = getProfile(name);
    if (!p){ sandbox.log = "–ü—Ä–æ—Ñ–∏–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω."; renderAll(); return; }
    sandbox.inv = cloneInv(p.inv||{});
    sandbox.log = `–ó–∞–≥—Ä—É–∂–µ–Ω–æ –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è: ${name}`;
    renderAll();
  });

  $("#save").addEventListener("click", () => {
    const v = $("#src").value;
    if (v === "sandbox"){
      const name = prompt("–ò–º—è –ø—Ä–æ—Ñ–∏–ª—è –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:", "–ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å");
      if (!name) return;
      upsertProfile(name, sandbox.inv);
      refreshProfilesSelect();
      $("#src").value = "p:" + normalizeName(name);
      sandbox.log = `–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤ –ø—Ä–æ—Ñ–∏–ª—å: ${normalizeName(name)}`;
      renderAll();
      return;
    }
    if (v.startsWith("p:")){
      const name = v.slice(2);
      upsertProfile(name, sandbox.inv);
      sandbox.log = `–û–±–Ω–æ–≤–ª—ë–Ω –ø—Ä–æ—Ñ–∏–ª—å: ${name}`;
      renderAll();
    }
  });

  // ---------- Init ----------
  (function init(){
    renderAll();
  })();

})();
</script>
</body>
</html>
